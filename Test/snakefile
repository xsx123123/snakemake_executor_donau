import time
import os
import random
import tempfile

# --- é…ç½®åŒºåŸŸ ---
# 1. å¢åŠ æ ·æœ¬é‡åˆ° 100 ä¸ªï¼Œæµ‹è¯•è°ƒåº¦å™¨ååé‡
SAMPLES = [f"sample_{i:03d}" for i in range(1, 101)]

rule all:
    input:
        "results/final_stress_report.txt"

# æ­¥éª¤1ï¼šå…¨æ–¹ä½å‹åŠ›æµ‹è¯• (CPU + MEM + IO + éšæœºå¤±è´¥)
rule hardcore_stress:
    output:
        "results/{sample}.result"
    resources:
        queue = "fat_x86",
        # åŠ¨æ€èµ„æºï¼šéƒ¨åˆ†ä»»åŠ¡ç”³è¯·å¤§å†…å­˜ï¼Œéƒ¨åˆ†ç”³è¯·å°å†…å­˜ï¼Œæµ‹è¯•è°ƒåº¦å™¨çš„"æ‹¼å›¾"èƒ½åŠ›
        mem_mb = lambda wildcards, attempt: 4096 if int(wildcards.sample.split('_')[1]) % 2 == 0 else 2048,
        runtime = 60
    threads: 1
    retries: 2  # ğŸŒŸ å…³é”®ï¼šå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒSnakemake ä¼šè‡ªåŠ¨é‡è¯• 2 æ¬¡
    run:
        import random
        
        # --- 0. æ··æ²Œæµ‹è¯• (æ¨¡æ‹Ÿéšæœºç½‘ç»œæ³¢åŠ¨æˆ–èŠ‚ç‚¹æ•…éšœ) ---
        # 10% çš„æ¦‚ç‡ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæµ‹è¯• Snakemake çš„ retries æ˜¯å¦ç”Ÿæ•ˆ
        if random.random() < 0.1:
            print("ğŸ’€ è§¦å‘éšæœºæ•…éšœ (Chaos Monkey)ï¼æ¨¡æ‹Ÿä»»åŠ¡å¤±è´¥...")
            raise Exception("Random Chaos Failure triggered! Snakemake should retry this.")

        print(f"[{wildcards.sample}] Host: {os.uname().nodename} | Attempt: {rule.retries}")
        
        # --- 1. å†…å­˜å‹åŠ› (Memory Stress) ---
        # ç”³è¯· 3GB (å¯¹äº 4GB çš„è¯·æ±‚) æˆ– 1.5GB (å¯¹äº 2GB çš„è¯·æ±‚)
        target_mem_gb = 3.0 if int(wildcards.sample.split('_')[1]) % 2 == 0 else 1.5
        print(f"ğŸ”¥ [MEM] æ­£åœ¨åˆ†é… {target_mem_gb}GB å†…å­˜...")
        try:
            # è¿™é‡Œçš„ bytearray ä¼šå®æ‰“å®åœ°å ç”¨ç‰©ç†å†…å­˜
            data_chunk = bytearray(int(target_mem_gb * 1024 * 1024 * 1024))
            # éšæœºè®¿é—®ä¸€ä¸‹æ•°ç»„ï¼Œé˜²æ­¢æ“ä½œç³»ç»Ÿè¿›è¡Œ"æƒ°æ€§åˆ†é…" (Lazy Allocation)
            data_chunk[100] = 1
            data_chunk[-100] = 1
            print("âœ… å†…å­˜åˆ†é…ä¸”è§¦è¾¾æˆåŠŸï¼")
        except MemoryError:
            raise MemoryError("âŒ å†…å­˜åˆ†é…å¤±è´¥ï¼é›†ç¾¤é™åˆ¶ç”Ÿæ•ˆäº†ã€‚")

        # --- 2. IO å‹åŠ› (Disk Stress) ---
        # æ¨¡æ‹Ÿç”Ÿä¿¡æµç¨‹ä¸­çš„å¤§é‡ä¸­é—´æ–‡ä»¶è¯»å†™ (100MB)
        print("ğŸ”¥ [IO] æ­£åœ¨è¿›è¡Œç£ç›˜ I/O è¯»å†™æµ‹è¯• (100MB)...")
        io_start = time.time()
        # åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œæµ‹è¯•ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„å»¶è¿Ÿ
        temp_filename = f"{output[0]}.tmp_io_stress"
        with open(temp_filename, "wb") as f:
            # å†™ 100MB éšæœºæ•°æ®
            f.write(os.urandom(100 * 1024 * 1024)) 
        
        # è¯»å›æ¥
        with open(temp_filename, "rb") as f:
            _ = f.read()
        
        # åˆ æ‰
        os.remove(temp_filename)
        io_duration = time.time() - io_start
        print(f"âœ… IO æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {io_duration:.2f}s")

        # --- 3. CPU å‹åŠ› (Matrix Multiplication) ---
        # çº¯ Python è¿›è¡Œ 500x500 çŸ©é˜µä¹˜æ³•ï¼Œéå¸¸æ¶ˆè€— CPU
        print("ğŸ”¥ [CPU] æ­£åœ¨è¿›è¡ŒçŸ©é˜µä¹˜æ³• (500x500)...")
        cpu_start = time.time()
        size = 500
        A = [[random.random() for _ in range(size)] for _ in range(size)]
        B = [[random.random() for _ in range(size)] for _ in range(size)]
        # åªæ˜¯ä¸ºäº†çƒ¤æœºï¼Œç»“æœä¸é‡è¦ï¼Œç®—ä¸€éƒ¨åˆ†å³å¯é˜²æ­¢è¶…æ—¶
        # ä»…è®¡ç®—å¯¹è§’çº¿éƒ¨åˆ†ä»¥èŠ‚çœä¸€ç‚¹æ—¶é—´ï¼Œä½†ä¾ç„¶è¶³å¤Ÿ heavy
        result = [sum(a * b for a, b in zip(A_row, B_col)) for A_row, B_col in zip(A, zip(*B))]
        
        cpu_duration = time.time() - cpu_start
        print(f"âœ… CPU æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: {cpu_duration:.2f}s")

        # --- 4. å†™å…¥ç»“æœ ---
        with open(output[0], "w") as f:
            f.write(f"Sample: {wildcards.sample}\n")
            f.write(f"Host: {os.uname().nodename}\n")
            f.write(f"MEM Allocated: {target_mem_gb}GB\n")
            f.write(f"IO Time: {io_duration:.2f}s\n")
            f.write(f"CPU Time: {cpu_duration:.2f}s\n")
            f.write("Status: Survived\n")

# æ­¥éª¤2ï¼šæ±‡æ€»æŠ¥å‘Š
rule summarize_all:
    input:
        expand("results/{sample}.result", sample=SAMPLES)
    output:
        "results/final_stress_report.txt"
    resources:
        queue = "fat_x86",
        mem_mb = 1024
    threads: 1
    shell:
        """
        echo "=== ğŸŒ‹ ç»ˆæå‹åŠ›æµ‹è¯•æŠ¥å‘Š ===" > {output}
        echo "å®Œæˆæ—¶é—´: $(date)" >> {output}
        echo "æˆåŠŸæ ·æœ¬æ•°: $(ls results/*.result | wc -l) / 100" >> {output}
        echo "" >> {output}
        echo "--- èŠ‚ç‚¹è´Ÿè½½åˆ†å¸ƒ ---" >> {output}
        grep "Host" results/*.result | sort | uniq -c | sort -nr >> {output}
        echo "" >> {output}
        echo "--- æ€§èƒ½ç»Ÿè®¡ (å¹³å‡å€¼) ---" >> {output}
        echo "å¹³å‡ IO è€—æ—¶: $(grep "IO Time" results/*.result | awk '{{sum+=$3}} END {{print sum/NR}}') ç§’" >> {output}
        echo "å¹³å‡ CPU è€—æ—¶: $(grep "CPU Time" results/*.result | awk '{{sum+=$3}} END {{print sum/NR}}') ç§’" >> {output}
        """